// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION MODELS
// ============================================

model User {
  id                  String     @id @default(uuid())
  email               String     @unique
  emailVerified       Boolean    @default(false)
  emailVerifiedAt     DateTime?
  password            String
  firstName           String
  lastName            String
  phone               String?
  avatar              String?
  role                UserRole   @default(CLIENT_USER)
  status              UserStatus @default(PENDING)

  // Company
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  // Security
  mfaEnabled          Boolean   @default(false)
  mfaSecret           String?
  lastLoginAt         DateTime?
  lastLoginIp         String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  passwordChangedAt   DateTime?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions          Session[]
  refreshTokens     RefreshToken[]
  drivers           Driver[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  createdShipments  Shipment[]           @relation("CreatedBy")
  assignedShipments Shipment[]           @relation("AssignedTo")

  @@index([email])
  @@index([companyId])
  @@index([role])
  @@index([status])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model RefreshToken {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String    @unique
  expiresAt  DateTime
  isRevoked  Boolean   @default(false)
  replacedBy String?
  createdAt  DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  resource    String
  action      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permissions")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  LOGISTICS_MANAGER
  CARRIER_OPERATOR
  FLEET_MANAGER
  CLIENT_USER
  DRIVER
  CARRIER_ADMIN
  CARRIER_USER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

// ============================================
// COMPANY MODELS
// ============================================

model Company {
  id         String        @id @default(uuid())
  name       String
  businessId String        @unique
  taxId      String
  email      String
  phone      String
  website    String?
  status     CompanyStatus @default(PENDING)

  // Address
  street     String
  street2    String?
  city       String
  state      String
  postalCode String
  country    String
  latitude   Float?
  longitude  Float?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  users     User[]
  shipments Shipment[]
  carriers  Carrier[]

  @@map("companies")
}

enum CompanyStatus {
  ACTIVE
  PENDING
  SUSPENDED
  INACTIVE
}

// ============================================
// ADDRESS & CONTACT MODELS
// ============================================

model Address {
  id          String      @id @default(uuid())
  line1       String
  line2       String?
  city        String
  state       String
  postalCode  String
  country     String      @default("GB")
  latitude    Float?
  longitude   Float?
  type        AddressType
  facilityId  String?
  contactName String?
  phone       String?
  email       String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  shipmentsOrigin      Shipment[] @relation("ShipmentOrigin")
  shipmentsDestination Shipment[] @relation("ShipmentDestination")

  @@index([city])
  @@index([state])
  @@index([postalCode])
  @@map("addresses")
}

enum AddressType {
  WAREHOUSE
  CUSTOMER
  CARRIER
  TERMINAL
  DISTRIBUTION_CENTER
}

model Contact {
  id        String  @id @default(uuid())
  firstName String
  lastName  String
  company   String?
  email     String?
  phone     String
  role      String?
  notes     String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  shipmentsAsShipper   Shipment[] @relation("Shipper")
  shipmentsAsConsignee Shipment[] @relation("Consignee")
  shipmentsAsBillTo    Shipment[] @relation("BillTo")

  @@map("contacts")
}

// ============================================
// SHIPMENT MODELS (ENHANCED)
// ============================================

model Shipment {
  id              String           @id @default(uuid())
  shipmentNumber  String           @unique
  referenceNumber String?
  externalId      String?
  type            ShipmentType
  status          ShipmentStatus   @default(DRAFT)
  priority        ShipmentPriority @default(MEDIUM)
  serviceLevel    ServiceLevel     @default(STANDARD)
  mode            TransportMode

  // Origin & Destination with Address relations
  originId      String
  origin        Address @relation("ShipmentOrigin", fields: [originId], references: [id])
  destinationId String
  destination   Address @relation("ShipmentDestination", fields: [destinationId], references: [id])

  // Parties
  shipperId   String
  shipper     Contact  @relation("Shipper", fields: [shipperId], references: [id])
  consigneeId String
  consignee   Contact  @relation("Consignee", fields: [consigneeId], references: [id])
  billToId    String?
  billTo      Contact? @relation("BillTo", fields: [billToId], references: [id])

  // Carrier & Route
  carrierId String?
  carrier   Carrier? @relation(fields: [carrierId], references: [id])
  routeId   String?
  route     Route?   @relation(fields: [routeId], references: [id])
  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])
  driverId  String?
  driver    Driver?  @relation(fields: [driverId], references: [id])

  // Carrier details
  carrierServiceCode String?
  trackingNumber     String? @unique

  // Cargo details
  totalWeight  Float
  totalVolume  Float?
  totalValue   Float
  currency     String @default("GBP")
  packageCount Int
  palletCount  Int?
  weightUnit   WeightUnit
  dimensionUnit DimensionUnit

  // Dates & Times
  pickupDate        DateTime?
  pickupTimeStart   DateTime?
  pickupTimeEnd     DateTime?
  deliveryDate      DateTime?
  deliveryTimeStart DateTime?
  deliveryTimeEnd   DateTime?
  estimatedArrival  DateTime?
  actualPickup      DateTime?
  actualDelivery    DateTime?

  // Tracking
  currentLocation Json?
  iotDeviceId     String?

  // Financial
  declaredValue Float?
  freightCost   Float?
  insuranceCost Float?
  totalCost     Float?
  totalRevenue  Float?
  margin        Float?
  invoiced      Boolean @default(false)
  paid          Boolean @default(false)

  // Insurance & Risk
  insuranceRequired Boolean @default(false)
  insuranceAmount   Float?
  insuranceProvider String?

  // Special handling
  requiresSignature     Boolean @default(false)
  requiresAppointment   Boolean @default(false)
  temperatureControlled Boolean @default(false)
  temperatureMin        Float?
  temperatureMax        Float?
  temperatureUnit       String?
  hazmat                Boolean @default(false)
  fragile               Boolean @default(false)
  specialInstructions   String?

  // Metadata
  tags         String[]
  customFields Json?

  // Customer
  customerId    String
  company       Company @relation(fields: [customerId], references: [id])
  customerName  String
  customerEmail String?
  customerPhone String?

  // User tracking
  createdById  String
  createdBy    User    @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToId String?
  assignedTo   User?   @relation("AssignedTo", fields: [assignedToId], references: [id])

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items          ShipmentItem[]
  documents      ShipmentDocument[]
  trackingEvents ShipmentTracking[]
  routeStops     RouteStop[]
  invoices       Invoice[]
  sensorReadings SensorReading[]
  exceptions     Exception[]
  delays         Delay[]
  claims         Claim[]
  notes          Note[]

  @@index([shipmentNumber])
  @@index([status])
  @@index([carrierId])
  @@index([pickupDate])
  @@index([deliveryDate])
  @@index([customerId])
  @@index([createdById])
  @@map("shipments")
}

model ShipmentItem {
  id            String   @id @default(uuid())
  shipmentId    String
  shipment      Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  sku           String?
  description   String
  quantity      Int
  weight        Float
  volume        Float?
  value         Float?
  dimensions    Json? // {length, width, height, unit}
  packaging     String?
  serialNumbers String[]
  lotNumbers    String[]
  expiryDate    DateTime?
  hsCode        String?

  @@index([shipmentId])
  @@map("shipment_items")
}

model ShipmentDocument {
  id         String       @id @default(uuid())
  shipmentId String
  shipment   Shipment     @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  type       DocumentType
  name       String
  url        String
  format     String
  size       Int?
  uploadedAt DateTime     @default(now())
  uploadedBy String

  @@index([shipmentId])
  @@map("shipment_documents")
}

model ShipmentTracking {
  id          String         @id @default(uuid())
  shipmentId  String
  shipment    Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  eventType   EventType
  status      ShipmentStatus
  description String

  // Location
  location    String?
  coordinates Json? // {lat, lng}
  facility    String?

  timestamp DateTime @default(now())
  source    String // GPS, MANUAL, CARRIER_API, EDI
  createdBy String?
  metadata  Json?

  @@index([shipmentId])
  @@index([timestamp])
  @@map("shipment_tracking")
}

// IoT sensor readings
model SensorReading {
  id         String      @id @default(uuid())
  shipmentId String
  shipment   Shipment    @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  deviceId   String
  sensorType SensorType
  value      Float
  unit       String
  threshold  Float?
  status     AlertStatus @default(NORMAL)
  coordinates Json?
  timestamp  DateTime    @default(now())

  @@index([shipmentId])
  @@index([deviceId])
  @@index([timestamp])
  @@map("sensor_readings")
}

model Exception {
  id          String           @id @default(uuid())
  shipmentId  String
  shipment    Shipment         @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  type        ExceptionType
  severity    ExceptionSeverity
  description String
  resolvedAt  DateTime?
  resolvedBy  String?
  resolution  String?
  createdAt   DateTime         @default(now())

  @@index([shipmentId])
  @@map("exceptions")
}

model Delay {
  id          String   @id @default(uuid())
  shipmentId  String
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  reason      String
  duration    Int // minutes
  impactedETA DateTime?
  createdAt   DateTime @default(now())

  @@index([shipmentId])
  @@map("delays")
}

model Claim {
  id          String      @id @default(uuid())
  shipmentId  String
  shipment    Shipment    @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  type        ClaimType
  status      ClaimStatus
  amount      Float
  description String
  filedAt     DateTime    @default(now())
  resolvedAt  DateTime?
  resolution  String?

  @@index([shipmentId])
  @@map("claims")
}

model Note {
  id         String   @id @default(uuid())
  shipmentId String
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  content    String
  createdBy  String
  createdAt  DateTime @default(now())
  isPrivate  Boolean  @default(false)

  @@index([shipmentId])
  @@map("notes")
}

enum ShipmentType {
  INBOUND
  OUTBOUND
  RETURN
  STOCK_TRANSFER
}

enum ShipmentStatus {
  DRAFT
  PENDING
  CONFIRMED
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  EXCEPTION
  CANCELLED
  RETURNED
  FAILED
}

enum ShipmentPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ServiceLevel {
  STANDARD
  EXPRESS
  SAME_DAY
  NEXT_DAY
  TWO_DAY
  THREE_DAY
  ECONOMY
  GROUND
  OVERNIGHT
}

enum TransportMode {
  LTL
  FTL
  PARCEL
  AIR
  OCEAN
  RAIL
  INTERMODAL
  COURIER
}

enum WeightUnit {
  KG
  LB
  G
  OZ
}

enum DimensionUnit {
  CM
  IN
  M
  FT
}

enum DocumentType {
  LABEL
  BOL
  ASN
  INVOICE
  PACKING_LIST
  CUSTOMS_DECLARATION
  EXPORT_DECLARATION
  CERTIFICATE_OF_ORIGIN
  POD
  HAZMAT_DECLARATION
  OTHER
}

enum EventType {
  CREATED
  UPDATED
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  ARRIVED
  DEPARTED
  DELIVERED
  EXCEPTION
  DELAYED
  CANCELLED
}

enum SensorType {
  GPS
  TEMPERATURE
  HUMIDITY
  SHOCK
  TILT
  LIGHT
  DOOR
  BATTERY
  FUEL
  TIRE_PRESSURE
}

enum AlertStatus {
  NORMAL
  WARNING
  CRITICAL
}

enum ExceptionType {
  DAMAGED
  LOST
  WEATHER_DELAY
  MECHANICAL_FAILURE
  CUSTOMS_HOLD
  ADDRESS_ISSUE
  REFUSED
  OTHER
}

enum ExceptionSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ClaimType {
  DAMAGE
  LOSS
  DELAY
  OTHER
}

enum ClaimStatus {
  PENDING
  APPROVED
  DENIED
  CLOSED
}

// ============================================
// CARRIER MODELS (ENHANCED)
// ============================================

model Carrier {
  id          String        @id @default(uuid())
  code        String        @unique
  name        String
  legalName   String?
  scac        String?       @unique
  dot         String?
  mc          String?
  taxId       String?
  type        CarrierType
  modes       TransportMode[]
  status      CarrierStatus @default(ACTIVE)

  // Contact
  email       String
  phone       String
  website     String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?

  // Performance
  rating         Float?
  onTimeRate     Float?
  claimRate      Float?
  totalShipments Int   @default(0)
  totalRevenue   Float?

  // Insurance & Compliance
  insuranceAmount Float?
  insuranceExpiry DateTime?
  licenseExpiry   DateTime?
  certifications  String[]

  // Integration
  apiEndpoint String?
  apiKey      String?
  apiSecret   String?
  ediEnabled  Boolean @default(false)
  ediQualifier String?
  ediId       String?
  webhookUrl  String?

  // Approval
  approvedAt DateTime?
  approvedBy String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  services       CarrierService[]
  rates          CarrierRate[]
  contracts      CarrierContract[]
  tenderRequests TenderRequest[]
  shipments      Shipment[]
  serviceAreas   ServiceArea[]
  lanes          Lane[]
  capacities     Capacity[]

  @@index([code])
  @@index([scac])
  @@index([status])
  @@index([companyId])
  @@map("carriers")
}

model CarrierService {
  id           String  @id @default(uuid())
  carrierId    String
  carrier      Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  code         String
  name         String
  description  String?
  serviceLevel String
  transitTime  Int // in hours
  cutoffTime   String?
  baseRate     Float
  currency     String  @default("GBP")
  maxWeight    Float?
  maxLength    Float?
  maxWidth     Float?
  maxHeight    Float?
  isActive     Boolean @default(true)

  @@unique([carrierId, code])
  @@map("carrier_services")
}

model CarrierRate {
  id              String    @id @default(uuid())
  carrierId       String
  carrier         Carrier   @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  serviceId       String
  originZone      String
  destinationZone String
  weightFrom      Float
  weightTo        Float
  rate            Float
  currency        String    @default("GBP")
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  isActive        Boolean   @default(true)

  @@map("carrier_rates")
}

model CarrierContract {
  id             String         @id @default(uuid())
  carrierId      String
  carrier        Carrier        @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  contractNumber String         @unique
  startDate      DateTime
  endDate        DateTime
  status         ContractStatus
  minimumVolume  Int?
  discountTier   Float?
  terms          String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@map("carrier_contracts")
}

model TenderRequest {
  id                    String       @id @default(uuid())
  shipmentId            String
  carrierId             String
  carrier               Carrier      @relation(fields: [carrierId], references: [id])
  status                TenderStatus @default(PENDING)
  requestedAt           DateTime     @default(now())
  respondedAt           DateTime?
  expiresAt             DateTime
  quotedRate            Float?
  currency              String?
  estimatedPickupDate   DateTime?
  estimatedDeliveryDate DateTime?
  notes                 String?

  @@map("tender_requests")
}

model ServiceArea {
  id        String   @id @default(uuid())
  carrierId String
  carrier   Carrier  @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  name      String
  country   String
  state     String?
  city      String?
  postalCodes String[]
  isActive  Boolean  @default(true)

  @@map("service_areas")
}

model Lane {
  id              String   @id @default(uuid())
  carrierId       String
  carrier         Carrier  @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  name            String
  originCity      String
  originState     String
  destinationCity String
  destinationState String
  distance        Float
  baseRate        Float
  currency        String   @default("GBP")
  transitTime     Int // hours
  isActive        Boolean  @default(true)

  @@map("lanes")
}

model Capacity {
  id          String   @id @default(uuid())
  carrierId   String
  carrier     Carrier  @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  date        DateTime
  maxWeight   Float
  maxVolume   Float
  maxShipments Int
  available   Float
  reserved    Float
  utilized    Float

  @@map("capacities")
}

enum CarrierType {
  ASSET
  BROKER
  THREE_PL
  COURIER
  FREIGHT_FORWARDER
  LTL
  FTL
  PARCEL
  LAST_MILE
}

enum CarrierStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

enum TenderStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

// ============================================
// ROUTE & FLEET MODELS (ENHANCED)
// ============================================

model Route {
  id          String      @id @default(uuid())
  routeNumber String      @unique
  status      RouteStatus @default(PLANNED)

  vehicleId   String?
  vehicle     Vehicle?    @relation(fields: [vehicleId], references: [id])
  vehicleType VehicleType

  driverId   String?
  driver     Driver? @relation(fields: [driverId], references: [id])
  driverName String?

  totalDistance Float
  totalDuration Float
  distanceUnit  String @default("km")

  isOptimized       Boolean   @default(false)
  optimizedAt       DateTime?
  optimizationScore Float?

  plannedStartTime DateTime
  plannedEndTime   DateTime
  actualStartTime  DateTime?
  actualEndTime    DateTime?

  totalWeight   Float
  totalVolume   Float
  totalPackages Int

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  metadata  Json?

  // Relations
  stops     RouteStop[]
  shipments Shipment[]

  @@map("routes")
}

model RouteStop {
  id             String     @id @default(uuid())
  routeId        String
  route          Route      @relation(fields: [routeId], references: [id], onDelete: Cascade)
  sequenceNumber Int
  stopType       StopType
  status         StopStatus @default(PENDING)

  // Location
  street     String
  street2    String?
  city       String
  state      String
  postalCode String
  country    String
  latitude   Float?
  longitude  Float?
  facilityId String?

  // Timing
  plannedArrivalTime   DateTime
  plannedDepartureTime DateTime
  actualArrivalTime    DateTime?
  actualDepartureTime  DateTime?
  serviceTime          Int // in minutes

  completedAt DateTime?
  notes       String?

  // Contact
  contactName  String?
  contactPhone String?

  metadata Json?

  // Relations
  shipments Shipment[]

  @@map("route_stops")
}

model Vehicle {
  id            String        @id @default(uuid())
  vehicleNumber String        @unique
  type          VehicleType
  licensePlate  String        @unique
  status        VehicleStatus @default(AVAILABLE)

  make  String
  model String
  year  Int
  color String?
  vin   String?

  maxWeight  Float
  maxVolume  Float
  maxPallets Int?

  gpsDeviceId        String?
  currentLatitude    Float?
  currentLongitude   Float?
  lastLocationUpdate DateTime?

  assignedDriverId String?
  assignedRouteId  String?

  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?
  mileage             Int?
  fuelType            String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  routes          Route[]
  shipments       Shipment[]
  maintenanceRecords MaintenanceRecord[]
  fuelLogs        FuelLog[]

  @@map("vehicles")
}

model Driver {
  id            String       @id @default(uuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  driverNumber  String       @unique
  licenseNumber String
  licenseClass  String?
  licenseExpiry DateTime
  status        DriverStatus @default(ACTIVE)

  assignedVehicleId String?
  assignedRouteId   String?
  currentLatitude   Float?
  currentLongitude  Float?

  // Performance metrics
  totalDeliveries    Int   @default(0)
  onTimeDeliveryRate Float @default(0)
  averageRating      Float @default(0)
  totalMilesDriven   Float @default(0)
  hoursOfService     Float @default(0)
  metricsLastUpdated DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  routes    Route[]
  shipments Shipment[]

  @@map("drivers")
}

model MaintenanceRecord {
  id          String   @id @default(uuid())
  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  type        String
  description String
  cost        Float?
  mileage     Int?
  performedAt DateTime
  performedBy String?

  @@index([vehicleId])
  @@map("maintenance_records")
}

model FuelLog {
  id          String   @id @default(uuid())
  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  gallons     Float
  cost        Float
  pricePerGallon Float
  mileage     Int
  location    String?
  filledAt    DateTime @default(now())

  @@index([vehicleId])
  @@map("fuel_logs")
}

enum RouteStatus {
  PLANNED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VehicleType {
  VAN
  TRUCK
  CARGO_VAN
  BOX_TRUCK
  SEMI_TRUCK
  MOTORCYCLE
  BICYCLE
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  OUT_OF_SERVICE
}

enum DriverStatus {
  ACTIVE
  ON_DUTY
  OFF_DUTY
  BREAK
  INACTIVE
}

enum StopType {
  PICKUP
  DELIVERY
  PICKUP_AND_DELIVERY
}

enum StopStatus {
  PENDING
  EN_ROUTE
  ARRIVED
  COMPLETED
  FAILED
  SKIPPED
}

// ============================================
// BILLING MODELS
// ============================================

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  shipmentId    String
  shipment      Shipment      @relation(fields: [shipmentId], references: [id])
  status        InvoiceStatus @default(PENDING)
  subtotal      Float
  tax           Float
  total         Float
  currency      String        @default("GBP")
  dueDate       DateTime
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  charges Charge[]

  @@map("invoices")
}

model Charge {
  id          String  @id @default(uuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  amount      Float
  currency    String  @default("GBP")
  type        String

  @@index([invoiceId])
  @@map("charges")
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

// ============================================
// NOTIFICATION MODELS
// ============================================

model Notification {
  id         String             @id @default(uuid())
  userId     String
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       NotificationType
  title      String
  message    String
  data       Json?
  isRead     Boolean            @default(false)
  readAt     DateTime?
  createdAt  DateTime           @default(now())

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

enum NotificationType {
  SHIPMENT_UPDATE
  DELIVERY_COMPLETE
  EXCEPTION
  DELAY
  TENDER_REQUEST
  SYSTEM_ALERT
  OTHER
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
